<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RefScore Performance Results</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, Segoe UI, Arial, sans-serif; margin: 24px; color: #111; }
    h1 { margin: 0 0 8px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1000px) {
      .row { grid-template-columns: 1fr 1fr; }
    }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; }
    table { border-collapse: collapse; width: 100%; font-size: 12px; }
    th, td { padding: 6px 8px; border: 1px solid #e5e7eb; text-align: right; }
    th:first-child, td:first-child { text-align: left; }
    .controls { display: flex; align-items: center; gap: 12px; }
    .muted { color: #6b7280; font-size: 12px; }
    .btn { padding: 6px 10px; border: 1px solid #d1d5db; background: #f9fafb; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #f3f4f6; }
    canvas { background: #fff; }
  </style>
</head>
<body>
  <h1>RefScore Performance Results</h1>
  <div class="muted">Generated from tests/performance/BibFinderPerformance.test.ts</div>
  <div class="grid">
    <div class="row">
      <div class="card">
        <div class="controls">
          <div><strong>Total Time vs Source Count</strong></div>
          <button id="dl-line" class="btn">Download PNG</button>
        </div>
        <canvas id="lineChart" height="280"></canvas>
      </div>
      <div class="card">
        <div class="controls">
          <div><strong>Time Breakdown by Paper Type</strong></div>
          <label>
            Source Count:
            <select id="countSelect"></select>
          </label>
          <button id="dl-bar" class="btn">Download PNG</button>
        </div>
        <canvas id="barChart" height="280"></canvas>
      </div>
    </div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div><strong>Detailed Results</strong></div>
        <div>
          <a class="btn" href="./results.csv" download>Download CSV</a>
          <a class="btn" href="./results.json" download>Download JSON</a>
        </div>
      </div>
      <div id="tableWrap"></div>
    </div>
  </div>
  <script>
    const RESULTS = [{"PaperType":"Abstract","WordCount":200,"SourceCount":1,"BibParseTimeMs":"0.038","ExtractTimeMs":"0.033","LatexParseTimeMs":"0.081","TotalTimeMs":"0.151"},{"PaperType":"Abstract","WordCount":200,"SourceCount":50,"BibParseTimeMs":"1.080","ExtractTimeMs":"0.038","LatexParseTimeMs":"0.133","TotalTimeMs":"1.251"},{"PaperType":"Abstract","WordCount":200,"SourceCount":100,"BibParseTimeMs":"2.632","ExtractTimeMs":"0.049","LatexParseTimeMs":"0.110","TotalTimeMs":"2.791"},{"PaperType":"Abstract","WordCount":200,"SourceCount":250,"BibParseTimeMs":"6.389","ExtractTimeMs":"0.055","LatexParseTimeMs":"0.084","TotalTimeMs":"6.528"},{"PaperType":"Abstract","WordCount":200,"SourceCount":500,"BibParseTimeMs":"8.725","ExtractTimeMs":"0.049","LatexParseTimeMs":"0.080","TotalTimeMs":"8.854"},{"PaperType":"Abstract","WordCount":200,"SourceCount":1000,"BibParseTimeMs":"20.180","ExtractTimeMs":"0.063","LatexParseTimeMs":"0.083","TotalTimeMs":"20.326"},{"PaperType":"Short Paper","WordCount":2000,"SourceCount":1,"BibParseTimeMs":"0.023","ExtractTimeMs":"0.176","LatexParseTimeMs":"0.346","TotalTimeMs":"0.545"},{"PaperType":"Short Paper","WordCount":2000,"SourceCount":50,"BibParseTimeMs":"0.788","ExtractTimeMs":"0.236","LatexParseTimeMs":"0.371","TotalTimeMs":"1.395"},{"PaperType":"Short Paper","WordCount":2000,"SourceCount":100,"BibParseTimeMs":"1.758","ExtractTimeMs":"0.347","LatexParseTimeMs":"0.416","TotalTimeMs":"2.522"},{"PaperType":"Short Paper","WordCount":2000,"SourceCount":250,"BibParseTimeMs":"4.188","ExtractTimeMs":"0.242","LatexParseTimeMs":"0.361","TotalTimeMs":"4.791"},{"PaperType":"Short Paper","WordCount":2000,"SourceCount":500,"BibParseTimeMs":"9.490","ExtractTimeMs":"0.280","LatexParseTimeMs":"0.348","TotalTimeMs":"10.118"},{"PaperType":"Short Paper","WordCount":2000,"SourceCount":1000,"BibParseTimeMs":"20.735","ExtractTimeMs":"0.357","LatexParseTimeMs":"0.341","TotalTimeMs":"21.433"},{"PaperType":"Full Paper","WordCount":6000,"SourceCount":1,"BibParseTimeMs":"0.043","ExtractTimeMs":"0.654","LatexParseTimeMs":"0.933","TotalTimeMs":"1.629"},{"PaperType":"Full Paper","WordCount":6000,"SourceCount":50,"BibParseTimeMs":"0.867","ExtractTimeMs":"0.870","LatexParseTimeMs":"0.904","TotalTimeMs":"2.641"},{"PaperType":"Full Paper","WordCount":6000,"SourceCount":100,"BibParseTimeMs":"1.805","ExtractTimeMs":"0.659","LatexParseTimeMs":"0.986","TotalTimeMs":"3.450"},{"PaperType":"Full Paper","WordCount":6000,"SourceCount":250,"BibParseTimeMs":"4.990","ExtractTimeMs":"0.690","LatexParseTimeMs":"0.974","TotalTimeMs":"6.655"},{"PaperType":"Full Paper","WordCount":6000,"SourceCount":500,"BibParseTimeMs":"12.275","ExtractTimeMs":"0.895","LatexParseTimeMs":"0.869","TotalTimeMs":"14.038"},{"PaperType":"Full Paper","WordCount":6000,"SourceCount":1000,"BibParseTimeMs":"23.301","ExtractTimeMs":"1.051","LatexParseTimeMs":"1.379","TotalTimeMs":"25.731"},{"PaperType":"Review","WordCount":12000,"SourceCount":1,"BibParseTimeMs":"0.047","ExtractTimeMs":"1.199","LatexParseTimeMs":"2.463","TotalTimeMs":"3.709"},{"PaperType":"Review","WordCount":12000,"SourceCount":50,"BibParseTimeMs":"1.241","ExtractTimeMs":"1.906","LatexParseTimeMs":"1.881","TotalTimeMs":"5.028"},{"PaperType":"Review","WordCount":12000,"SourceCount":100,"BibParseTimeMs":"2.086","ExtractTimeMs":"1.769","LatexParseTimeMs":"1.959","TotalTimeMs":"5.814"},{"PaperType":"Review","WordCount":12000,"SourceCount":250,"BibParseTimeMs":"5.876","ExtractTimeMs":"1.576","LatexParseTimeMs":"1.939","TotalTimeMs":"9.391"},{"PaperType":"Review","WordCount":12000,"SourceCount":500,"BibParseTimeMs":"10.786","ExtractTimeMs":"1.236","LatexParseTimeMs":"1.882","TotalTimeMs":"13.904"},{"PaperType":"Review","WordCount":12000,"SourceCount":1000,"BibParseTimeMs":"23.688","ExtractTimeMs":"1.694","LatexParseTimeMs":"2.192","TotalTimeMs":"27.575"},{"PaperType":"Thesis","WordCount":30000,"SourceCount":1,"BibParseTimeMs":"0.074","ExtractTimeMs":"4.078","LatexParseTimeMs":"4.567","TotalTimeMs":"8.719"},{"PaperType":"Thesis","WordCount":30000,"SourceCount":50,"BibParseTimeMs":"4.285","ExtractTimeMs":"4.964","LatexParseTimeMs":"5.296","TotalTimeMs":"14.544"},{"PaperType":"Thesis","WordCount":30000,"SourceCount":100,"BibParseTimeMs":"2.300","ExtractTimeMs":"6.064","LatexParseTimeMs":"4.456","TotalTimeMs":"12.820"},{"PaperType":"Thesis","WordCount":30000,"SourceCount":250,"BibParseTimeMs":"5.861","ExtractTimeMs":"3.277","LatexParseTimeMs":"4.563","TotalTimeMs":"13.702"},{"PaperType":"Thesis","WordCount":30000,"SourceCount":500,"BibParseTimeMs":"15.987","ExtractTimeMs":"5.684","LatexParseTimeMs":"4.715","TotalTimeMs":"26.387"},{"PaperType":"Thesis","WordCount":30000,"SourceCount":1000,"BibParseTimeMs":"31.293","ExtractTimeMs":"6.198","LatexParseTimeMs":"5.238","TotalTimeMs":"42.728"}];
    const counts = Array.from(new Set(RESULTS.map(r => r.SourceCount))).sort((a,b)=>a-b);
    const paperTypes = Array.from(new Set(RESULTS.map(r => r.PaperType)));

    const colorPool = [
      '#2563eb','#16a34a','#dc2626','#ca8a04','#7c3aed','#0ea5e9','#f97316'
    ];
    const colorFor = (i) => colorPool[i % colorPool.length];

    const totalsByType = paperTypes.map((pt, idx) => ({
      label: pt,
      borderColor: colorFor(idx),
      backgroundColor: colorFor(idx) + '55',
      tension: 0.2,
      data: counts.map(c => {
        const rec = RESULTS.find(r => r.PaperType === pt && r.SourceCount === c);
        return rec ? Number(rec.TotalTimeMs) : 0;
      })
    }));

    const lineCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: counts,
        datasets: totalsByType
      },
      options: {
        plugins: {
          legend: { position: 'bottom' },
          tooltip: { mode: 'nearest', intersect: false }
        },
        scales: {
          x: { title: { display: true, text: 'Source Count' } },
          y: { title: { display: true, text: 'Total Time (ms)' }, beginAtZero: true }
        }
      }
    });

    const select = document.getElementById('countSelect');
    counts.forEach(c => {
      const opt = document.createElement('option');
      opt.value = String(c);
      opt.textContent = String(c);
      select.appendChild(opt);
    });
    select.value = String(counts[counts.length - 1]);

    const mkBreakdownDatasets = (sourceCount) => {
      const cat = ['BibParseTimeMs','ExtractTimeMs','LatexParseTimeMs'];
      return cat.map((k, i) => ({
        label: k.replace('TimeMs',''),
        backgroundColor: colorFor(i),
        data: paperTypes.map(pt => {
          const rec = RESULTS.find(r => r.PaperType === pt && r.SourceCount === sourceCount);
          return rec ? Number(rec[k]) : 0;
        })
      }));
    };

    const barCtx = document.getElementById('barChart').getContext('2d');
    let barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: paperTypes,
        datasets: mkBreakdownDatasets(Number(select.value))
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          x: { stacked: true },
          y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Time (ms)' } }
        }
      }
    });

    select.addEventListener('change', () => {
      barChart.data.datasets = mkBreakdownDatasets(Number(select.value));
      barChart.update();
    });

    document.getElementById('dl-line').addEventListener('click', () => {
      const url = lineChart.toBase64Image('image/png', 1);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'refscore_line_chart.png';
      a.click();
    });
    document.getElementById('dl-bar').addEventListener('click', () => {
      const url = barChart.toBase64Image('image/png', 1);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'refscore_breakdown_chart.png';
      a.click();
    });

    const wrap = document.getElementById('tableWrap');
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    const cols = ['PaperType','WordCount','SourceCount','BibParseTimeMs','ExtractTimeMs','LatexParseTimeMs','TotalTimeMs'];
    const trh = document.createElement('tr');
    cols.forEach(c => { const th = document.createElement('th'); th.textContent = c; trh.appendChild(th); });
    thead.appendChild(trh);
    RESULTS.forEach(r => {
      const tr = document.createElement('tr');
      cols.forEach(c => { const td = document.createElement('td'); td.textContent = r[c]; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
    table.appendChild(thead);
    table.appendChild(tbody);
    wrap.appendChild(table);
  </script>
</body>
</html>